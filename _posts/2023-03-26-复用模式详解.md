---
title: 复用模式详解
date: 2023-03-26 10:34:00 +0800
categories: [计算机]
tags: [语言/CPP]
pin: false
author: ZashJie

toc: true
comments: true
typora-root-url: ../../ZashJie.github.io
math: false
mermaid: true


---

#项目/WebServer 
### `select` `poll` `epoll` 

#### 得知有事件发生的区别
- `select` 跟 `poll` 都是遍历整个文件描述符，去判断是否有活动；
- `epoll` 通过轮询机制监视文件描述符，当文件描述符有事件发生时，会自动触发 `epoll` 回调函数通知 `epoll` 文件描述符，然后将就绪的文件描述符放到 `epoll` 维护的 `ready list` 中，等待 `epoll_wait` 调用后被处理

#### 底层结构的区别
- `select` 是由**线性表**来描述 文件描述符的集合，**文件描述符有上限**
- `poll` 是由**链表**描述 文件描述符的集合
- `epoll` 的底层是**红黑树**，并且维护一个 `ready_list` （**链表**），其中包含着那些已就绪的事件

#### 它们各自的缺点

- `select` 跟 `poll` 
	- 这两种复用方式，在调用的时候需要将文件描述符集合拷贝到内核态中；
	- 并且只能应用于 LT水平触发模式
- `epoll` 
	- 是将文件描述符集合维护在内核态中，但是添加文件描述时，需要执行一个系统调用而造成较大的开销；
	- `epoll` 支持水平触发模式 跟 边缘触发模式
	[[epoll_wait()函数]]

#### 分别的应用场景
- 当监听的 文件描述符 数量较少，且单位时间内都比较活跃的情况下（频繁发生），使用 `select` 或 `poll`
- 当监听的 文件描述符 数量较多，且单位时间内仅部分活跃的情况下，使用 `epoll`


## 两种触发模式

### LT（水平触发模式）

一般来说水平触发模式类似`select`，LT会去遍历在epoll事件表中每个文件描述符，来观察是否有我们感兴趣的事件发生（也就是 是否处于活跃状态），如果有（触发了该文件描述符上的回调函数），`epoll_wait`就会以非阻塞的方式返回。该模式可以不立即处理新的事件，所以若该epoll事件没有被处理完（没有返回`EWOULDBLOCK`），该事件还会被后续的`epoll_wait`再次触发，继续读取未完成的数据。

##### 应用场景
适合连接较少的场景，复杂度低且容器理解和使用

##### LT实现

通过 `if` 条件判断处理连接，且只处理一次连接请求，然后创建定时器
	本项目中其实只有在建立新连接的时候有用到LT，并主要体现在处理一次连接请求那，下次有新的请求再通过LT去处理

### ET（边缘触发模式）

ET在发现有我们感兴趣的事件发生后，立即返回，并且使用非阻塞IO方式读取数据，直到数据全部读取完毕或者出现 `EWOULDBLOCK` 错误码。
	  在使用ET模式时，必须要保证该文件描述符是非阻塞的（确保在没有数据可读时，该文件描述符不会一直阻塞）；并且每次调用`read`和`write`的时候都必须等到它们返回`EWOULDBLOCK`（确保所有数据都已读完或写完）。

##### 应用场景
适合连接较多的场景，在高并发场景下有更高的效率
	同样也是在建立新连接的时候用到了ET，并主要体现在一次读到底那

### ET 实现

通过 `while` 循环来处理连接请求，因为边缘触发可能会同时接到多个连接请求，循环处理并分别创建定时器