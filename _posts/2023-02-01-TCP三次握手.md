---
title: TCP三次握手
date: 2023-02-01 10:34:00 +0800
categories: [计算机]
tags: [网络/TCP]
pin: false
author: ZashJie

toc: true
comments: true
typora-root-url: ../../ZashJie.github.io
math: false
mermaid: true


---


#网络/TCP

### 概要
TCP的三次握手是一个建立连接所必要的一个连接流程，通过TCP的三次握手能够保证双方之间都具有接收和发送数据的能力

### 连接过程

##### 握手前的准备
一开始发送方的状态都为 `CLOSE` 状态，因为都是客户端发送连接，所以我将请求发送方称为客户端，请求接收方称为服务端。
首先服务端会主动对某一个端口进行监听，服务端处于 `LISTEN` 状态

##### 第一次握手
客户端会随机初始化序号 `client_isn` ，将此序号放到TCP首部的序号字段中，同时将 `SYN` 标志位 置为一，表示该报文为 `SYN` 报文，随后服务器为 `SYN-SENT` 状态

##### 第二次握手
服务端接收到客户端发来的请求报文后，首先服务端也随机初始化自己的序号 `server_isn` 放到TCP首部的序号字段中，并将TCP首部的确认应答字段填入 `client_isn+1`，接着把SYN跟ACK置为一，随后服务端处于`SYN_RCVD`状态

##### 第三次握手
客户端在接收到服务端的报文后，还要向服务器回应最后一个应答报文，将TCP首部的确认应答字段填入 `server_isn+1`，并将ACK标志位置为一，最后把报文发送给服务端，之后客户端处于 ESTABLISHED 状态
注意，第三次握手是可以携带数据的

##### 连接完成
服务端接收到客户端发来的应答报文，也进入了 `ESTABLISHED `状态，至此连接就完成了，双方可以互相通信了

##### 三次握手解析图
![TCP 三次握手](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4/%E7%BD%91%E7%BB%9C/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.drawio.png)

### 深层问题

##### 为什么不进行两次握手就建立连接呢
[[在TCP中，为什么不能两次握手达成TCP连接]]

### TCP三次握手中消耗序号 

只有单独的 `ACK` 应答报文不会消耗序号，所以只有在TCP的第三次握手中（其中不夹杂信息）的报文不会消耗序号

### 如果不进行 `accept` 最多有多少个连接建立成功

##### 半连接队列
只要服务端接收到客户端发来的 SYN 报文时，就会将连接存放到 半连接队列中
##### 全连接队列
在进行三次握手完后，TCP建立连接成功，服务端会将建立成功的连接存放在 全连接队列中
**全连接队列的大小** ，这个大小由 `accept` 函数中的 `backlog` 参数决定

##### `accpet` 的作用
能够将全连接队列中的连接，获取到应用程序中


### 一个进程可以有多少个TCP连接

这个连接数目是由系统决定的，通过 `limit -a` 找到 `open files` ，规定了一个进程最多有多少个文件描述符
